app-id: org.sugarlabs.MusicBlocks
branch: stable
runtime: org.freedesktop.Platform
runtime-version: '19.08'
sdk: org.freedesktop.Sdk
base: "org.electronjs.Electron2.BaseApp"
base-version: '19.08'
separate-locales: false
command: musicblocks-run
finish-args:
  - '--share=ipc'
  - '--socket=x11'
  - '--socket=pulseaudio'
  - '--share=network'
  - '--device=dri'
  - '--filesystem=home'
  - '--env=MUSICBLOCKS_PATH=/app/share/musicblocks'
modules:
  - name: unappimage
    buildsystem: simple
    build-commands:
      - make -C squashfs-tools -j ${FLATPAK_BUILDER_N_JOBS} install INSTALL_DIR=${FLATPAK_DEST}/bin
    sources:
      - type: git
        url: https://github.com/refi64/unappimage
        commit: d7f86f2a0d7ec3a69211125207d5f127386b849a
  
  - name: mb-data
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST}

      - install -d /app/share/appdata
      - mv /app/share/metadata/org.sugarlabs.MusicBlocks.appdata.xml /app/share/appdata
      
      - unappimage MusicBlocks.AppImage
      - rm MusicBlocks.AppImage
      - mv squashfs-root /app/bin/musicblocks
    sources:
      - type: git
        path: '..'
        branch: 'HEAD'
      - type: file
        dest-filename: MusicBlocks.AppImage
        url: https://github.com/sugarlabs/musicblocks-launcher/releases/download/continuous/MusicBlocks-3.5.1-arm64.AppImage
        sha256: 40e35c6b3ce230fcf18f70919bc33db2b4fadd9b4fcb21ed8c9a9fd1291b06a0
        size: 140783237
        only-arches:
          - aarch64
      - type: file
        dest-filename: MusicBlocks.AppImage
        url: https://github.com/sugarlabs/musicblocks-launcher/releases/download/continuous/MusicBlocks-3.5.1-armv7l.AppImage
        sha256: b12ee8f0083c673523b76a37893f76543efe5aa543f1c4c69a72711cf398c467
        size: 125620259
        only-arches:
          - arm
      - type: file
        dest-filename: MusicBlocks.AppImage
        url: https://github.com/sugarlabs/musicblocks-launcher/releases/download/continuous/MusicBlocks-3.5.1-x86_64.AppImage
        sha256: 55fcc4fd61c278d41caddded502ed5ff3bf867386e5ae382d0b793611fca7ea5
        size: 134913872
        only-arches:
          - x86_64

  - name: musicblocks
    buildsystem: simple
    build-commands:
      - install -Dm 755 musicblocks-run /app/bin/musicblocks-run
    sources:
      - type: script
        dest-filename: musicblocks-run
        commands:
          - exec /app/bin/musicblocks/musicblocks "$@" --no-sandbox
